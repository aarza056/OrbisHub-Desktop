# Auto-Update System Documentation

## Overview
OrbisHub Desktop now includes an automatic update system that checks for new versions and allows users to download and install updates without manually downloading installers.

## How It Works

### 1. Update Checking
- Automatically checks for updates **3 seconds after app startup**
- Re-checks every **4 hours** while the app is running
- Manual check available via `window.electronAPI.checkForUpdates()`

### 2. Update Notification
When an update is available:
- A notification appears in the bottom-right corner
- Shows the new version number
- Provides "Download" and "Later" buttons

### 3. Download Process
- User clicks "Download" button
- Progress bar shows download percentage and data transferred
- Download happens in the background

### 4. Installation
- Once downloaded, "Restart & Install" button appears
- Clicking it closes the app and installs the update
- App automatically restarts after installation

## Setup Requirements

### 1. Install Dependencies
```bash
npm install electron-updater --save
```

### 2. Configure Update Server
You need a server to host your releases. Options:

#### Option A: GitHub Releases (Recommended)
```json
"build": {
  "publish": [
    {
      "provider": "github",
      "owner": "your-username",
      "repo": "orbis-desktop"
    }
  ]
}
```

#### Option B: Generic HTTP Server
```json
"build": {
  "publish": [
    {
      "provider": "generic",
      "url": "https://your-server.com/releases"
    }
  ]
}
```

#### Option C: Amazon S3
```json
"build": {
  "publish": [
    {
      "provider": "s3",
      "bucket": "your-bucket-name",
      "region": "us-east-1"
    }
  ]
}
```

### 3. Build and Publish
```bash
# Build the app
npm run build:win

# Publish to configured server (requires credentials)
npm run build:win -- --publish always
```

## File Structure
Your update server should have this structure:
```
releases/
├── latest.yml                 # Update metadata
├── OrbisHub-Desktop-Setup-1.0.0.exe
├── OrbisHub-Desktop-Setup-1.0.1.exe
└── ...
```

The `latest.yml` file is auto-generated by electron-builder:
```yaml
version: 1.0.1
files:
  - url: OrbisHub-Desktop-Setup-1.0.1.exe
    sha512: [hash]
    size: 123456789
path: OrbisHub-Desktop-Setup-1.0.1.exe
sha512: [hash]
releaseDate: '2024-11-15T10:00:00.000Z'
```

## Publishing Updates

### Using GitHub Releases
1. Create a new release on GitHub
2. Build with publish flag:
   ```bash
   npm run build:win -- --publish always
   ```
3. Authenticate with GitHub token (set `GH_TOKEN` environment variable)

### Using Generic Server
1. Build the app:
   ```bash
   npm run build:win
   ```
2. Upload to your server:
   - `OrbisHub-Desktop-Setup-X.X.X.exe`
   - `latest.yml`

### Version Bumping
Update version in `package.json`:
```json
{
  "version": "1.0.1"
}
```

## Testing Updates

### Local Testing (Development Mode)
```javascript
// In main.js, add during development:
autoUpdater.updateConfigPath = path.join(__dirname, 'dev-app-update.yml');
```

Create `dev-app-update.yml`:
```yaml
provider: generic
url: http://localhost:8080/releases
```

### Staging Server
Use a test server URL:
```json
"publish": {
  "provider": "generic",
  "url": "https://test.your-server.com/releases"
}
```

## Security Considerations

1. **Code Signing**: Sign your builds with a valid certificate
   ```json
   "win": {
     "certificateFile": "path/to/cert.pfx",
     "certificatePassword": "your-password"
   }
   ```

2. **HTTPS Only**: Always use HTTPS for update servers

3. **Signature Verification**: electron-updater automatically verifies signatures

## Customization

### Update Check Interval
Change in `main.js`:
```javascript
// Check every 2 hours instead of 4
setInterval(() => {
    autoUpdater.checkForUpdates();
}, 2 * 60 * 60 * 1000);
```

### Auto-Download
Enable automatic downloading:
```javascript
autoUpdater.autoDownload = true;  // Changed from false
```

### Notification Style
Modify `app/styles.css` `.update-notification` class

### Notification Position
Change in `app/styles.css`:
```css
.update-notification {
  bottom: 20px;    /* Distance from bottom */
  right: 20px;     /* Distance from right */
}
```

## Troubleshooting

### Updates Not Detected
- Check network connectivity
- Verify `latest.yml` is accessible
- Check console for errors: `autoUpdater.on('error', console.error)`

### Download Fails
- Ensure firewall allows electron
- Check HTTPS certificate validity
- Verify file permissions on server

### Installation Fails
- Run as administrator
- Check antivirus settings
- Verify code signing certificate

## API Reference

### Main Process (main.js)
```javascript
// Check for updates
autoUpdater.checkForUpdates()

// Download update
autoUpdater.downloadUpdate()

// Install update
autoUpdater.quitAndInstall(false, true)

// Events
autoUpdater.on('update-available', (info) => {})
autoUpdater.on('update-downloaded', (info) => {})
autoUpdater.on('error', (error) => {})
autoUpdater.on('download-progress', (progress) => {})
```

### Renderer Process (app-main.js)
```javascript
// Check for updates manually
await window.electronAPI.checkForUpdates()

// Download update
await window.electronAPI.downloadUpdate()

// Install update
window.electronAPI.installUpdate()

// Get current version
const version = await window.electronAPI.getAppVersion()

// Listen for events
window.electronAPI.onUpdateAvailable((info) => {})
window.electronAPI.onUpdateDownloaded((info) => {})
window.electronAPI.onUpdateDownloadProgress((progress) => {})
window.electronAPI.onUpdateError((error) => {})
```

## Best Practices

1. **Test updates thoroughly** on a staging environment
2. **Communicate changes** via release notes
3. **Monitor update adoption** rates
4. **Keep old versions** available for rollback
5. **Sign all releases** with valid certificates
6. **Use semantic versioning** (major.minor.patch)

## Example Release Workflow

1. Update version in `package.json`
2. Commit changes: `git commit -am "Release v1.0.1"`
3. Create git tag: `git tag v1.0.1`
4. Push with tags: `git push --tags`
5. Build and publish: `npm run build:win -- --publish always`
6. Wait 3-4 hours for users to receive update notification

## Support

For issues or questions:
- Check electron-updater docs: https://www.electron.build/auto-update
- Review console logs in dev tools
- Test with `electron-updater` debug mode: `export DEBUG=electron-updater`
